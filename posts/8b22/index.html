<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>ANR 触发原理与分析 | Winter's Blog</title><meta name="author" content="Winter"><meta name="copyright" content="Winter"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ANR 触发原理与分析1、什么是 ANR？ANR（Application Not Responding）是指应用程序未响应，Android 系统对于一些事件需要在一定时间范围内完成，如果超过预定时间未能得到有效响应或者响应时间过长，都会造成 ANR。 ANR 的产生需要满足三个条件：  主线程：只有应用程序的主线程响应超时才会产生 ANR 超时时间：产生ANR的上下文不同，超时时间也会不同，但是只"><meta property="og:type" content="article"><meta property="og:title" content="ANR 触发原理与分析"><meta property="og:url" content="https://winter-ruize.github.io/posts/8b22/index.html"><meta property="og:site_name" content="Winter&#39;s Blog"><meta property="og:description" content="ANR 触发原理与分析1、什么是 ANR？ANR（Application Not Responding）是指应用程序未响应，Android 系统对于一些事件需要在一定时间范围内完成，如果超过预定时间未能得到有效响应或者响应时间过长，都会造成 ANR。 ANR 的产生需要满足三个条件：  主线程：只有应用程序的主线程响应超时才会产生 ANR 超时时间：产生ANR的上下文不同，超时时间也会不同，但是只"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://winter-ruize.github.io/images/avatar.jpg"><meta property="article:published_time" content="2024-02-01T08:53:39.000Z"><meta property="article:modified_time" content="2024-02-06T02:14:53.000Z"><meta property="article:author" content="Winter"><meta property="article:tag" content="ANR"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://winter-ruize.github.io/images/avatar.jpg"><link rel="shortcut icon" href="/images/avatar_circle.png"><link rel="canonical" href="https://winter-ruize.github.io/posts/8b22/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:1,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,noticeOutdate:{limitDay:365,position:"top",messagePrev:"It has been",messageNext:"days since the last update, the content of the article may be outdated."},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:200},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!0,post:!1},runtime:"天",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:50,languages:{author:"作者: Winter",link:"链接: ",source:"来源: Winter's Blog",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体中文",cht_to_chs:"你已切换为简体中文",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#1f1f1f",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js",buttonText:"加载更多"},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1,percent:{toc:!0,rightside:!0},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"ANR 触发原理与分析",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-02-06 10:14:53"}</script><script>(e=>{e.saveToLocal={set:(e,t,o)=>{if(0===o)return;const a={value:t,expiry:Date.now()+864e5*o};localStorage.setItem(e,JSON.stringify(a))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!(Date.now()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=(e,t={})=>new Promise((o,a)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=a,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,o())},Object.keys(t).forEach(e=>{n.setAttribute(e,t[e])}),document.head.appendChild(n)}),e.getCSS=(e,t=!1)=>new Promise((o,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,t&&(n.id=t),n.onerror=a,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,o())},document.head.appendChild(n)}),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme");"dark"===t?activateDarkMode():"light"===t&&activateLightMode();const o=saveToLocal.get("aside-status");void 0!==o&&("hide"===o?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><meta name="generator" content="Hexo 7.1.1"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{const d=document.getElementById("loading-box"),e=document.body,o=()=>{e.style.overflow="",d.classList.add("loaded")},l=()=>{e.style.overflow="hidden",d.classList.remove("loaded")};l(),window.addEventListener("load",()=>{o()})})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messagesboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/images/wallpaper/wallpaper-013.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="Winter's Blog"><span class="site-name">Winter's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messagesboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ANR 触发原理与分析<a class="post-edit-link" href="https://github.com/winter-ruize/hexo_blog/edit/main/source/_posts/ANR触发原理与分析.md" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-02-01T08:53:39.000Z" title="发表于 2024-02-01 16:53:39">2024-02-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-02-06T02:14:53.000Z" title="更新于 2024-02-06 10:14:53">2024-02-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android/">Android</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android/App/">App</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>20分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="ANR 触发原理与分析"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ANR-触发原理与分析"><a href="#ANR-触发原理与分析" class="headerlink" title="ANR 触发原理与分析"></a>ANR 触发原理与分析</h1><h2 id="1、什么是-ANR？"><a href="#1、什么是-ANR？" class="headerlink" title="1、什么是 ANR？"></a>1、什么是 ANR？</h2><p><strong>ANR（Application Not Responding）</strong>是指应用程序未响应，Android 系统对于一些事件需要在一定时间范围内完成，如果超过预定时间未能得到有效响应或者响应时间过长，都会造成 ANR。</p><p>ANR 的产生需要满足三个条件：</p><ul><li>主线程：只有<strong>应用程序的主线程</strong>响应超时才会产生 ANR</li><li>超时时间：<strong>产生ANR的上下文不同，超时时间也会不同</strong>，但是只要这个时间上线内没有响应就会 ANR</li><li>输入事件&#x2F;特定事件：<strong>输入事件是指按键、触屏等设备输入事件，特定操作是指 BroadcastReceiver 和 Service 的生命周期中的各个函数</strong>，产生 ANR 的上下文不同，导致 ANR 的原因也会不同</li></ul><p>为了降低因网络访问导致的 ANR，在 Android 4.0 之后强制规定访问网络必须在子线程处理，如果在主线程访问网络将会抛出 NetworkOnMainThreadException。</p><p>只要是耗时操作都可能会阻塞主线程，耗时操作要求放在子线程。</p><h2 id="2、ANR-发生场景"><a href="#2、ANR-发生场景" class="headerlink" title="2、ANR 发生场景"></a>2、ANR 发生场景</h2><table><thead><tr><th>ANR 事件</th><th>超时时间</th><th>相应日志描述</th></tr></thead><tbody><tr><td>点击事件（按键和触摸事件）</td><td>5s 内没被处理</td><td>Input event dispatching timed out</td></tr><tr><td>Service</td><td>前台 Service 20s，后台 Service 200s 未完成启动</td><td>Timeout executing service</td></tr><tr><td>BroadcastReceiver</td><td>前台广播 10s，后台广播 60s，onReceive() 在规定时间内未处理完</td><td>Timeout of broadcast Broadcast Record</td></tr><tr><td>ContentProvider</td><td>publish 在 10s 内没处理完</td><td>Timeout publishing content providers</td></tr></tbody></table><blockquote><p>需要注意的是，前台广播的 ANR 时间虽然是 10s 内 onReceive() 没有执行完就提示，这是在没有点击触摸事件导致 ANR 的前提下才是 10s，否则会先触发点击事件的 ANR，onReceive() 有可能执行不到 10s 就发生 ANR，所以不要在 onReceive() 处理耗时操作。</p></blockquote><p>在实际项目中，大多数的 ANR 都是点击触摸事件超时导致，会超时的原因也主要由以下三个原因导致：</p><ul><li>数据导致的 ANR：频繁 GC 导致线程暂停，处理事件时间被拉长</li><li>线程阻塞或死锁导致的 ANR</li><li>Binder 导致的 ANR：Binder 通信数据量过大</li></ul><h2 id="3、系统对-ANR-的捕捉原理"><a href="#3、系统对-ANR-的捕捉原理" class="headerlink" title="3、系统对 ANR 的捕捉原理"></a>3、系统对 ANR 的捕捉原理</h2><p><img src="/images/loading.gif" data-original="https://github.com/winter-ruize/blog_images/raw/main/images/2024/01/31/1706702632767.png" alt="系统对 ANR 的捕捉原理"></p><p>ANR 的触发过程可以理解为装炸弹和拆炸弹的过程。在本质上，<strong>ANR 也是建立在主线程 Looper 机制上的</strong>，简单理解就是<strong>先发送一个延时消息，然后在特定位置移除这个消息，如果消息没有被移除则证明整个流程出现问题，执行 ANR 处理</strong>。</p><p>触发 ANR 生成日志时，在不同的系统版本会有所不同，上图中是通过 ANRHelper 类处理 ANR 日志收集，在其他较低系统版本上是 AppErrors 类处理 ANR 日志收集。</p><h2 id="4、分析-ANR"><a href="#4、分析-ANR" class="headerlink" title="4、分析 ANR"></a>4、分析 ANR</h2><h3 id="4-1、日志分析思路"><a href="#4-1、日志分析思路" class="headerlink" title="4.1、日志分析思路"></a>4.1、日志分析思路</h3><ul><li>ANR 日志准备（traces.txt + mainlog）</li><li>在 traces.txt 找到 ANR 信息（<strong>发生 ANR 时间节点、主线程状态、事故点、ANR 类型</strong>）</li><li>在 mainlog 日志分析发生 ANR 时的 <strong>CPU 状态</strong></li><li>在 traces.txt 分析发生 ANR 时的 <strong>GC 情况（分析内存）</strong></li></ul><h3 id="4-2、ANR-日志准备（traces-txt-mainlog）"><a href="#4-2、ANR-日志准备（traces-txt-mainlog）" class="headerlink" title="4.2、ANR 日志准备（traces.txt + mainlog）"></a>4.2、ANR 日志准备（traces.txt + mainlog）</h3><p>在发生 ANR 的时候，系统会收集 ANR 相关的信息提供给开发者：</p><ul><li>发生 ANR 时会收集 trace 信息能找到各个线程的执行情况和 GC 信息，trace 文件保存在 <code>/data/anr/traces.txt</code></li><li>在 mainlog 日志中有 ANR 相关的信息和发生 ANR 时的 CPU 使用情况</li></ul><p><strong>简单说就是我们至少需要两份文件：&#x2F;data&#x2F;anr&#x2F;traces.txt 和 mainlog 日志</strong>。如果有 eventlog 能更快的定位到 ANR 的类型，当然 traces.txt 和 mainlog 也能分析得到。</p><p>traces.txt 文件通过命令 <code>adb pull /data/anr/</code> 获取。</p><p>mainlog 日志需要在程序运行时就时刻记录 <code>adb logcat -v time -b main &gt; mainlog.log</code>。</p><h3 id="4-3、traces-txt-信息概览"><a href="#4-3、traces-txt-信息概览" class="headerlink" title="4.3、traces.txt 信息概览"></a>4.3、traces.txt 信息概览</h3><p>当发生 ANR 时系统会在 <code>/data/anr/</code> 目录额外生成一份 traces.txt 日志，方便我们可以了解到发生 ANR 时的基本信息和堆栈信息。</p><p>traces.txt 日志信息如下（以主线程为例）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// main 代表的主线程</span><br><span class="line">// Native 是线程状态</span><br><span class="line">// 下面的是堆栈信息</span><br><span class="line">&quot;main&quot; prio=5 tid=1 Native</span><br><span class="line">  | group=&quot;main&quot; sCount=1 dsCount=0 obj=0x73cff4c0 self=0xafa84400</span><br><span class="line">  | sysTid=5790 nice=0 cgrp=top-app sched=1073741825/1 handle=0xb2717534</span><br><span class="line">  | state=S schedstat=( 3240607247 80660807 2053 ) utm=283 stm=41 core=1 HZ=100</span><br><span class="line">  | stack=0xbe7c1000-0xbe7c3000 stackSize=8MB</span><br><span class="line">  | held mutexes=</span><br><span class="line">  kernel: (couldn&#x27;t read /proc/self/task/5790/stack)</span><br><span class="line">  native: #00 pc 00048968  /system/lib/libc.so (__ioctl+8)</span><br><span class="line">  native: #01 pc 0001b0cf  /system/lib/libc.so (ioctl+38)</span><br><span class="line">  native: #02 pc 0003cd25  /system/lib/libbinder.so (_ZN7android14IPCThreadState14talkWithDriverEb+168)</span><br><span class="line">  native: #03 pc 0003d737  /system/lib/libbinder.so (_ZN7android14IPCThreadState15waitForResponseEPNS_6ParcelEPi+238)</span><br><span class="line">  native: #04 pc 0003662d  /system/lib/libbinder.so (_ZN7android8BpBinder8transactEjRKNS_6ParcelEPS1_j+36)</span><br><span class="line">  native: #05 pc 000999cf  /system/lib/libandroid_runtime.so (???)</span><br><span class="line">  native: #06 pc 00607b09  /system/framework/arm/boot-framework.oat (Java_android_os_BinderProxy_transactNative__ILandroid_os_Parcel_2Landroid_os_Parcel_2I+140)</span><br><span class="line">  at android.os.BinderProxy.transactNative(Native method)</span><br><span class="line">  at android.os.BinderProxy.transact(Binder.java:930)</span><br><span class="line">  at android.view.IWindowSession$Stub$Proxy.remove(IWindowSession.java:924)</span><br><span class="line">  at android.view.ViewRootImpl.dispatchDetachedFromWindow(ViewRootImpl.java:3306)</span><br><span class="line">  at android.view.ViewRootImpl.doDie(ViewRootImpl.java:5961)</span><br><span class="line">  - locked &lt;0x0ed5befa&gt; (a android.view.ViewRootImpl)</span><br><span class="line">  at android.view.ViewRootImpl.die(ViewRootImpl.java:5938)</span><br><span class="line">  at android.view.WindowManagerGlobal.removeViewLocked(WindowManagerGlobal.java:459)</span><br><span class="line">  at android.view.WindowManagerGlobal.removeView(WindowManagerGlobal.java:397)</span><br><span class="line">  - locked &lt;0x05ba7d9d&gt; (a java.lang.Object)</span><br><span class="line">  at android.view.WindowManagerImpl.removeViewImmediate(WindowManagerImpl.java:126)</span><br><span class="line">  at d.h.b.q.n.a$c.removeViewImmediate(SourceFile:1)</span><br><span class="line">  at android.widget.Toast$TN.handleHide(Toast.java:496)</span><br><span class="line">  at android.widget.Toast$TN$2.handleMessage(Toast.java:346)</span><br><span class="line">  at android.os.Handler.dispatchMessage(Handler.java:102)</span><br><span class="line">  at android.os.Looper.loop(Looper.java:154)</span><br><span class="line">  at android.app.ActivityThread.main(ActivityThread.java:6193)</span><br><span class="line">  at java.lang.reflect.Method.invoke!(Native method)</span><br><span class="line">  at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:886)</span><br><span class="line">  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:776)</span><br></pre></td></tr></table></figure><table><thead><tr><th>关键信息</th><th>描述</th></tr></thead><tbody><tr><td>main</td><td>main 标识是主线程。在 traces.txt 中如果是线程会命名为 “thread-x” 的格式，x 表示线程 id，逐步递增</td></tr><tr><td>prio</td><td>线程优先级，默认是 5</td></tr><tr><td>tid</td><td>tid 不是线程的 id，是线程唯一标识 id</td></tr><tr><td>group</td><td>线程组名称</td></tr><tr><td>sCount</td><td>该线程被挂起的次数</td></tr><tr><td>dsCount</td><td>线程被调试器挂起的次数</td></tr><tr><td>obj</td><td>对象地址</td></tr><tr><td>self</td><td>该线程 native 的地址</td></tr><tr><td>sysTid</td><td>线程号（主线程的线程号和进程号相同）</td></tr><tr><td>nice</td><td>线程的调度优先级</td></tr><tr><td>sched</td><td>分别标志了线程的调度策略和优先级</td></tr><tr><td>cgrp</td><td>调度归属组</td></tr><tr><td>handle</td><td>线程处理函数的地址</td></tr><tr><td>state</td><td>调度状态</td></tr><tr><td>schedstat</td><td>从 /proc/[pid]/task/[tid]/schedstat 读出，三个值分别表示线程在 cpu 上执行的时间、线程的等待时间和线程执行的时间片长度，不支持这项信息的三个值都是 0</td></tr><tr><td>utm</td><td>线程用户态下使用的时间值（单位是 jiffies）</td></tr><tr><td>stm</td><td>内核态下的调度时间值</td></tr><tr><td>core</td><td>最后执行这个线程的 cpu 核的序号</td></tr></tbody></table><table><thead><tr><th>线程状态</th><th>说明</th><th>描述</th></tr></thead><tbody><tr><td>UNDEFINED = -1</td><td></td><td></td></tr><tr><td>ZOMBIE = 0</td><td>TERMINATED</td><td>线程已经终止</td></tr><tr><td>RUNNING = 1</td><td>RUNNABLE or running now</td><td>正常运行</td></tr><tr><td>TIMED_WAIT = 2</td><td>TIMED_WAITING Object.wait()</td><td>等待，一般是调用 Object.wait(2000)</td></tr><tr><td>MONITOR = 3</td><td>BLOCKED on a monitor</td><td>synchronized</td></tr><tr><td>WAIT = 4</td><td>WAITING in Object.wait()</td><td>调用 Object.wait() 或 LockSupport.park() 等待</td></tr><tr><td>INITIALIZING = 5</td><td>allocated, not yet running</td><td>已经初始化线程，但是还没有进行 start</td></tr><tr><td>STARTING = 6</td><td>started, not yet on thread list</td><td>已经 start 但是没有 run</td></tr><tr><td>NATIVE = 7</td><td>off in a JNI native method</td><td>native 线程出问题，有三种常见情况：<br>1、项目自己有 JNI 开发线程<br>2、有 IO 操作（IO 的本质是调用 Linux 内核的函数）<br>3、AQS 锁住了</td></tr><tr><td>VMWAIT = 8</td><td>waiting on a VM resource</td><td>没有时间片</td></tr><tr><td>SUSPENDED = 9</td><td>suspended，usually by GC or debugger</td><td>被 GC 挂起的（该情况发生的可能性不高）</td></tr><tr><td>Blocked</td><td></td><td>死锁（查看 CPU usage 会发现几乎都是 0%，这也是死锁的体现）</td></tr></tbody></table><blockquote><p><strong>重点关注线程状态和堆栈信息</strong>，如果堆栈信息中有我们应用的函数，它们能够帮助我们快速定位到具体位置。</p></blockquote><h3 id="4-4、在-traces-txt-找到-ANR-信息（发生-ANR-时间节点、主线程状态、事故点、ANR-类型）"><a href="#4-4、在-traces-txt-找到-ANR-信息（发生-ANR-时间节点、主线程状态、事故点、ANR-类型）" class="headerlink" title="4.4、在 traces.txt 找到 ANR 信息（发生 ANR 时间节点、主线程状态、事故点、ANR 类型）"></a>4.4、在 traces.txt 找到 ANR 信息（<strong>发生 ANR 时间节点、主线程状态、事故点、ANR 类型</strong>）</h3><p>当我们拿到 traces.txt 文件时，主要找四个信息：<strong>发生 ANR 时的时间节点、主线程状态（在文件中搜索 main）、ANR 类型、事故点（堆栈信息中找到我们应用中的函数）</strong>。</p><p>分析发生 ANR 时进程中各个线程的堆栈，一般有几种情况：</p><ul><li><p>主线程状态是 <strong>Runnable</strong> 或 <strong>Native</strong>，堆栈信息中有我们应用中的函数，则很有可能就是执行该函数时候发生了超时</p></li><li><p>主线程状态是 <strong>Block</strong>，非常明显的线程被锁，这时候可以看是被哪个线程锁了，可以考虑优化代码，如果是死锁问题，就更需要及时解决了</p></li><li><p>由于抓 trace 的时刻很有可能耗时操作已经执行完了（ANR -&gt; 耗时操作执行完毕 -&gt; 系统抓 trace），这时候的 trace 就没有什么用了（在堆栈信息找不到我们应用的函数调用）</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/data/anr/traces.txt</span><br><span class="line"></span><br><span class="line">// 发生 ANR 时的时间节点</span><br><span class="line">----- pid 5790 at 2022-05-23 10:21:32 -----</span><br><span class="line"></span><br><span class="line">// 主线程状态</span><br><span class="line">&quot;main&quot; prio=5 tid=1 Waiting</span><br><span class="line"></span><br><span class="line">// 事故点</span><br><span class="line">// 不一定能找到我们应用的调用函数，因为抓 trace 的时候耗时操作可能已经执行完了，例如下面的堆栈</span><br><span class="line">at android.os.BinderProxy.transactNative(Native method)</span><br><span class="line">at android.os.BinderProxy.transact(Binder.java:930)</span><br><span class="line">at android.view.IWindowSession$Stub$Proxy.remove(IWindowSession.java:924)</span><br><span class="line">at android.view.ViewRootImpl.dispatchDetachedFromWindow(ViewRootImpl.java:3306)</span><br><span class="line">at android.view.ViewRootImpl.doDie(ViewRootImpl.java:5961)</span><br><span class="line">- locked &lt;0x0ed5befa&gt; (a android.view.ViewRootImpl)</span><br><span class="line">at android.view.ViewRootImpl.die(ViewRootImpl.java:5938)</span><br><span class="line">at android.view.WindowManagerGlobal.removeViewLocked(WindowManagerGlobal.java:459)</span><br><span class="line">at android.view.WindowManagerGlobal.removeView(WindowManagerGlobal.java:397)</span><br><span class="line">- locked &lt;0x05ba7d9d&gt; (a java.lang.Object)</span><br><span class="line">at android.view.WindowManagerImpl.removeViewImmediate(WindowManagerImpl.java:126)</span><br><span class="line">at d.h.b.q.n.a$c.removeViewImmediate(SourceFile:1)</span><br><span class="line">at android.widget.Toast$TN.handleHide(Toast.java:496)</span><br><span class="line">at android.widget.Toast$TN$2.handleMessage(Toast.java:346)</span><br><span class="line">at android.os.Handler.dispatchMessage(Handler.java:102)</span><br><span class="line">at android.os.Looper.loop(Looper.java:154)</span><br><span class="line">at android.app.ActivityThread.main(ActivityThread.java:6193)</span><br><span class="line">at java.lang.reflect.Method.invoke!(Native method)</span><br><span class="line">at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:886)</span><br><span class="line">at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:776)</span><br></pre></td></tr></table></figure><p>因为从上面的堆栈中其实不能分析到 ANR 类型，所以可以再借助 eventlog 或 mainlog 日志找到，可以在 mainlog 日志搜索关键词 <strong>ANR in</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mainlog.log（对应的 adb logcat -v time -b main &gt; mainlog.log）</span><br><span class="line"></span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager: ANR in com.example.demo (com.example.demo/.ui.login.LoginActivity)</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager: PID: 5790</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager: PSS: 42718 kB</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager: Reason: Input dispatching timed out (Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it.  Outbound queue length: 0.  Wait queue length: 1.)</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager: Load: 16.16 / 10.88 / 4.95</span><br></pre></td></tr></table></figure><p>在 eventlog 日志搜索关键词 <strong>am_anr</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">05-23 10:20:29.166  2003  2016 I am_anr  : [0,3392,com.example.demo,955792964,Input dispatching timed out (Waiting because no window has focus but there is a focused application that may eventually add a window when it finishes starting up.)]</span><br></pre></td></tr></table></figure><h3 id="4-5、在-mainlog-日志分析发生-ANR-时的-CPU-状态"><a href="#4-5、在-mainlog-日志分析发生-ANR-时的-CPU-状态" class="headerlink" title="4.5、在 mainlog 日志分析发生 ANR 时的 CPU 状态"></a>4.5、在 mainlog 日志分析发生 ANR 时的 CPU 状态</h3><p>在 mainlog 日志中根据 ANR 时间节点并搜索关键词 <strong>CPU usage</strong> 查看发生 ANR 前后 CPU 的使用情况，从 CPU usage 信息中大概可以分析：</p><ul><li><p>如果某些进程的 CPU 占用百分比较高，几乎占用了所有 CPU 资源，而发生 ANR 的进程（一般说的是我们的 app 进程）CPU 占用为 0% 或非常低，则认为 CPU 资源被占用，app 进程没有被分配足够的资源，从而发生了 ANR。这种情况多数可以认为是系统状态的问题，并不是由应用造成的（<strong>简单讲就是其他进程 CPU 使用率非常高自己低，就是系统资源分配不足导致</strong>）；</p></li><li><p>如果发生 ANR 的进程（一般说的是我们的 app 进程）CPU 占用较高，如到了 80% 或 90% 以上，则可以怀疑应用内一些代码不合理消耗掉了 CPU 资源，如出现了死循环或者后台有许多线程执行任务等等原因，这就要结合 traces.txt 和 ANR 前后的 mainlog 日志进一步分析（<strong>简单理解就是 IO 非常频繁，要么死循环了，要么上锁了</strong>）；</p></li><li><p>如果 CPU 总用量不高，该进程和其他进程的占用过高，这有一定概率是由于某些主线程的操作就是耗时过长，或者是由于主进程被锁造成的。</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">mainlog.log</span><br><span class="line"></span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager: CPU usage from 2068ms to -8489ms ago (2022-05-23 10:21:27.434 to 2022-05-23 10:21:37.991):</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   30% 2003/system_server: 16% user + 14% kernel / faults: 7835 minor 541 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   13% 5790/com.example.demo: 9.2% user + 3.9% kernel / faults: 11775 minor 141 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   5.4% 247/mmcqd/0: 0% user + 5.4% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   5.4% 2591/com.xtc.i3launcher: 4.3% user + 1% kernel / faults: 4186 minor 276 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   3.3% 36/kworker/u8:3: 0% user + 3.3% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   2.9% 410/audioserver: 1.7% user + 1.2% kernel / faults: 79 minor 3 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   2.8% 5754/com.netease.xtc.cloudmusic: 2.8% user + 0% kernel / faults: 1954 minor 315 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   2.3% 2457/com.android.phone: 1.6% user + 0.7% kernel / faults: 2226 minor 513 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   2.2% 35/kworker/u8:2: 0% user + 2.2% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   2.2% 356/surfaceflinger: 0.9% user + 1.3% kernel / faults: 464 minor</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   2.1% 110/kswapd0: 0% user + 2.1% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   2% 448/kworker/u8:8: 0% user + 2% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   1.9% 444/kworker/u8:7: 0% user + 1.9% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   1.9% 4683/kworker/u8:9: 0% user + 1.9% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   1.4% 4782/com.android.commands.monkey: 0.5% user + 0.8% kernel / faults: 1598 minor 3 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   1.1% 299/logd: 0.5% user + 0.5% kernel / faults: 200 minor 115 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   1.1% 3499/super_log: 0.2% user + 0.8% kernel / faults: 69 minor 1 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0.9% 7/rcu_preempt: 0% user + 0.9% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0.8% 2795/com.android.dialer: 0.7% user + 0% kernel / faults: 1270 minor 221 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0.4% 4696/mdss_fb0: 0% user + 0.4% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0.3% 12/ksoftirqd/1: 0% user + 0.3% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0.3% 20/ksoftirqd/3: 0% user + 0.3% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0.3% 258/core_ctl/0: 0% user + 0.3% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0.3% 2178/VosRXThread: 0% user + 0.3% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0.3% 2183/sdcard: 0% user + 0.3% kernel / faults: 42 minor 3 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0.2% 3/ksoftirqd/0: 0% user + 0.2% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0.2% 290/jbd2/mmcblk0p43: 0% user + 0.2% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0.1% 15/migration/2: 0% user + 0.1% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0.1% 16/ksoftirqd/2: 0% user + 0.1% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0.1% 19/migration/3: 0% user + 0.1% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0.1% 269/kworker/0:4: 0% user + 0.1% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0.1% 355/servicemanager: 0% user + 0% kernel / faults: 68 minor</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 1//init: 0% user + 0% kernel / faults: 6 minor 4 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 5/kworker/0:0H: 0% user + 0% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 8/rcu_sched: 0% user + 0% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 10/migration/0: 0% user + 0% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 11/migration/1: 0% user + 0% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 14/kworker/1:0H: 0% user + 0% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 135/mdp3_ppp: 0% user + 0% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 223/irq/114-5-0024: 0% user + 0% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 271/kworker/0:1H: 0% user + 0% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 276/kworker/3:3: 0% user + 0% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 309/debuggerd: 0% user + 0% kernel / faults: 237 minor 27 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 415/media.extractor: 0% user + 0% kernel / faults: 117 minor 66 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 419/netd: 0% user + 0% kernel / faults: 134 minor 2 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 2177/VosTXThread: 0% user + 0% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 2713/com.xtc.i3launcher:push: 0% user + 0% kernel / faults: 955 minor 58 major</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 2767/perffeedbackd: 0% user + 0% kernel / faults: 77 minor</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager:   0% 4546/kworker/1:3: 0% user + 0% kernel</span><br><span class="line">05-23 10:21:38.029  2003  2016 E ActivityManager: 84% TOTAL: 14% user + 17% kernel + 51% iowait + 0.6% softirq</span><br></pre></td></tr></table></figure><p>发生死锁时的 CPU 状态如下：</p><p><img src="/images/loading.gif" data-original="https://github.com/winter-ruize/blog_images/raw/main/images/2024/01/31/1706702632878.png" alt="发生死锁时的 CPU 状态"></p><h3 id="4-6、在-traces-txt-分析发生-ANR-时的-GC-情况（分析内存）"><a href="#4-6、在-traces-txt-分析发生-ANR-时的-GC-情况（分析内存）" class="headerlink" title="4.6、在 traces.txt 分析发生 ANR 时的 GC 情况（分析内存）"></a>4.6、在 traces.txt 分析发生 ANR 时的 GC 情况（分析内存）</h3><p>当上面分析了 CPU 状态后发现是非 CPU 问题时，就需要从内存 GC 分析，因为 GC 会触发 STW（Stop The World）导致线程执行时间被拉长。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 这里只截取了一部分 GC 信息</span><br><span class="line">// 如果还有其他信息，还需要分析如 GC 回收率等，下面的 GC 信息是正常的，这里仅用于展示</span><br><span class="line">Total time waiting for GC to complete: 64.298ms</span><br><span class="line">Total GC count: 30</span><br><span class="line">Total GC time: 4.961s</span><br><span class="line">Total blocking GC count: 1</span><br><span class="line">Total blocking GC time: 149.286ms</span><br></pre></td></tr></table></figure><h3 id="6-7、小结"><a href="#6-7、小结" class="headerlink" title="6.7、小结"></a>6.7、小结</h3><p>ANR 问题主要分为两类问题：</p><ul><li><strong>CPU 问题</strong></li><li><strong>GC 问题</strong></li></ul><p><strong>定位 ANR 的步骤为：</strong></p><ul><li><p><strong>判定是否为 CPU 问题：常见的是在主线程事件发生</strong></p></li><li><p><strong>如果非 CPU 问题，再去定位 GC 问题</strong></p></li><li><p><strong>GC 问题直接去看 traces.txt 上面的 GC 信息</strong></p><ul><li><p><strong>常规 GC 导致的问题，就是有频繁的对象创建</strong></p></li><li><p><strong>常规少量数据不会出现有这个问题，但是数据量异常将会引发连锁反应，ANR 是结果的体现，具体体现是卡顿和内存泄漏</strong></p></li></ul></li></ul><h2 id="5、总结"><a href="#5、总结" class="headerlink" title="5、总结"></a>5、总结</h2><ul><li><strong>在 traces.txt 找到发生 ANR 时间节点、主线程的状态、ANR 类型和事故点</strong></li><li><strong>在 mainlog 日志查看 CPU 状态</strong></li><li><strong>根据以上步骤收集的信息大致判断问题原因</strong><ul><li><strong>是 CPU 问题还是 非 CPU 问题</strong></li><li><strong>如果是非 CPU 问题，那么看 GC 处理信息</strong></li></ul></li><li><strong>在 traces.txt 分析 CG 信息</strong></li><li><strong>结合项目代码和以上步骤分析到的原因，定位到问题修复 ANR</strong></li></ul><p>其实 ANR 发生的原因本质上只有三个：</p><ul><li><strong>线程挂起</strong></li><li><strong>CPU 不给资源</strong></li><li><strong>GC 触发 STW 导致线程执行时间被拉长</strong></li></ul></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://winter-ruize.github.io">Winter</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://winter-ruize.github.io/posts/8b22/">https://winter-ruize.github.io/posts/8b22/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://winter-ruize.github.io" target="_blank">Winter's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ANR/">ANR</a></div><div class="post_share"><div class="social-share" data-image="/images/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/8656/" title="android 各种文件夹路径"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">android 各种文件夹路径</div></div></a></div><div class="next-post pull-right"><a href="/posts/75d1/" title="ATV 开机向导定制化与预置客制化 Launcher"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ATV 开机向导定制化与预置客制化 Launcher</div></div></a></div></nav><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">Winter</div><div class="author-info__description">Study hard and make progress every day!</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/winter-ruize"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/winter-ruize" target="_blank" title="Github"><i class="fab fa-github" style="color:#24292e"></i></a><a class="social-icon" href="mailto:winter.ruize@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color:#4a7dbe"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ANR-%E8%A7%A6%E5%8F%91%E5%8E%9F%E7%90%86%E4%B8%8E%E5%88%86%E6%9E%90"><span class="toc-text">ANR 触发原理与分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF-ANR%EF%BC%9F"><span class="toc-text">1、什么是 ANR？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81ANR-%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF"><span class="toc-text">2、ANR 发生场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E7%B3%BB%E7%BB%9F%E5%AF%B9-ANR-%E7%9A%84%E6%8D%95%E6%8D%89%E5%8E%9F%E7%90%86"><span class="toc-text">3、系统对 ANR 的捕捉原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%88%86%E6%9E%90-ANR"><span class="toc-text">4、分析 ANR</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1%E3%80%81%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E6%80%9D%E8%B7%AF"><span class="toc-text">4.1、日志分析思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%E3%80%81ANR-%E6%97%A5%E5%BF%97%E5%87%86%E5%A4%87%EF%BC%88traces-txt-mainlog%EF%BC%89"><span class="toc-text">4.2、ANR 日志准备（traces.txt + mainlog）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3%E3%80%81traces-txt-%E4%BF%A1%E6%81%AF%E6%A6%82%E8%A7%88"><span class="toc-text">4.3、traces.txt 信息概览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4%E3%80%81%E5%9C%A8-traces-txt-%E6%89%BE%E5%88%B0-ANR-%E4%BF%A1%E6%81%AF%EF%BC%88%E5%8F%91%E7%94%9F-ANR-%E6%97%B6%E9%97%B4%E8%8A%82%E7%82%B9%E3%80%81%E4%B8%BB%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81%E3%80%81%E4%BA%8B%E6%95%85%E7%82%B9%E3%80%81ANR-%E7%B1%BB%E5%9E%8B%EF%BC%89"><span class="toc-text">4.4、在 traces.txt 找到 ANR 信息（发生 ANR 时间节点、主线程状态、事故点、ANR 类型）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5%E3%80%81%E5%9C%A8-mainlog-%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%8F%91%E7%94%9F-ANR-%E6%97%B6%E7%9A%84-CPU-%E7%8A%B6%E6%80%81"><span class="toc-text">4.5、在 mainlog 日志分析发生 ANR 时的 CPU 状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6%E3%80%81%E5%9C%A8-traces-txt-%E5%88%86%E6%9E%90%E5%8F%91%E7%94%9F-ANR-%E6%97%B6%E7%9A%84-GC-%E6%83%85%E5%86%B5%EF%BC%88%E5%88%86%E6%9E%90%E5%86%85%E5%AD%98%EF%BC%89"><span class="toc-text">4.6、在 traces.txt 分析发生 ANR 时的 GC 情况（分析内存）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7%E3%80%81%E5%B0%8F%E7%BB%93"><span class="toc-text">6.7、小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">5、总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/8656/" title="android 各种文件夹路径">android 各种文件夹路径</a><time datetime="2024-03-12T03:49:42.000Z" title="发表于 2024-03-12 11:49:42">2024-03-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/8b22/" title="ANR 触发原理与分析">ANR 触发原理与分析</a><time datetime="2024-02-01T08:53:39.000Z" title="发表于 2024-02-01 16:53:39">2024-02-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/75d1/" title="ATV 开机向导定制化与预置客制化 Launcher">ATV 开机向导定制化与预置客制化 Launcher</a><time datetime="2024-02-01T08:53:39.000Z" title="发表于 2024-02-01 16:53:39">2024-02-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/e1e6/" title="Android Binder(C++ 实现)">Android Binder(C++ 实现)</a><time datetime="2024-02-01T08:53:39.000Z" title="发表于 2024-02-01 16:53:39">2024-02-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/6ba1/" title="Android P&amp;Q&amp;R&amp;S User 版本开启 adb root 权限">Android P&amp;Q&amp;R&amp;S User 版本开启 adb root 权限</a><time datetime="2024-02-01T08:53:39.000Z" title="发表于 2024-02-01 16:53:39">2024-02-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 By Winter</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><div class="js-pjax"><script>(()=>{const t=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://vercel-blog-lime.vercel.app/",region:"ap-shanghai",onCommentLoaded:()=>{btf.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null))},o=()=>{"object"==typeof twikoo?setTimeout(t,0):getScript("https://cdn.jsdelivr.net/npm/twikoo@1.6.31/dist/twikoo.all.min.js").then(t)};o()})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"rect":"opacity:0.7","log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body></html>